<!DOCTYPE html>
<html>
<head>
	<title>NotUber: COMP20 Assignment 2</title>
	<meta charset="utf-8">
	<link href="style.css" rel="stylesheet" />
</head>
<body onload="getMyLocation()">

<div id="map"> <h1> Loading...</h1> </div>

<script>
    myLat = 0;
	myLng = 0;
	
	
	function getMyLocation() {
		navigator.geolocation.getCurrentPosition(gotLocation);
	}

	function gotLocation(position) {
		myLat = position.coords.latitude;
		myLng = position.coords.longitude;	
		initMap(); 
		performRequest(); 
	}


	function performRequest() {
	rideRequest = new XMLHttpRequest(); 
	rideRequest.open("POST", "https://jordan-marsh.herokuapp.com/rides", true);
	rideRequest.setRequestHeader ("Content-type", "application/x-www-form-urlencoded"); 

	rideRequest.onreadystatechange = function() {
				if (rideRequest.readyState == 4 && rideRequest.status == 200) {
					responseInfo = rideRequest.responseText; 
					responseInfo = JSON.parse(responseInfo); 
					userMap ();  
				}
			}
	rideRequest.send("username=nzLw9wQbNd&lat=" + myLat + "&lng=" + myLng); 
	
	}

    function initMap() {
    	myPos = {lat: myLat, lng: myLng}; 
    	map = new google.maps.Map(document.getElementById('map'), {
        	center: myPos,
        	zoom: 15
        });
      }

    function userMap () {
    	vehicleImg = {url:  '/car.png', 
    				  scaledSize: new google.maps.Size(25, 50)
    				 } ;

    	passengerImg = {url:  '/person.png', 
    					scaledSize: new google.maps.Size(35, 50)
    					} ; 


    	if (responseInfo.passengers == undefined) {
    		var myMarker = new google.maps.Marker({
   		 	position: myPos,
    		map: map,
    		icon: passengerImg});

    		vehicles = responseInfo.vehicles;
    		numV = vehicles.length; 

    		for (i = 0; i < numV; i++){
    			var userMarker = new google.maps.Marker({
   		 		position: {lat:vehicles[i].lat, lng:vehicles[i].lng}, 
    			map: map,
    			icon: vehicleImg});  
    		}
    	}

    	else if (responseInfo.vehicles == undefined) {
    		var myMarker = new google.maps.Marker({
   		 	position: myPos,
    		map: map,
    		icon: vehicleImg
    
  			});
    	}

    } 

    </script>

<script async defer
      src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAA3e7VPgMhZFgCEqXFvt4fnh9jNvpe4C8">
</script>
	




</body>
</html>